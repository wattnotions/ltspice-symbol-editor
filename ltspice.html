<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LTspice .asy Viewer</title>
  <style>
    html,body{height:100%;margin:0;font:14px/1.3 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{background:#0f1317;color:#e9eef3;display:grid;grid-template-rows:auto 1fr}
    header{padding:10px 12px;background:#141a20;border-bottom:1px solid #273341}
    main{display:grid;grid-template-columns:280px 1fr;gap:12px;padding:12px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .panel{background:#141a20;border:1px solid #273341;border-radius:12px}
    .controls{padding:12px}
    input[type=file]{display:none}
    label#pick{cursor:pointer;padding:8px 12px;border-radius:10px;border:1px solid #334456;background:#19222c}
    #stage{display:grid;place-items:center;padding:12px}
    #svg{width:100%;height:100%;min-height:420px;background:#c7c7c7;border-radius:10px}
    .status{padding:10px 12px;border-top:1px solid #273341;color:#9fb0c0}
  </style>
</head>
<body>
  <header><strong>LTspice .asy Viewer</strong></header>
  <main>
    <section class="panel controls">
      <label id="pick" for="file">Select .asy file</label>
      <input id="file" type="file" accept=".asy,text/plain" />
      <p style="color:#9fb0c0;margin:10px 0 0">Scroll to zoom. (Grid always on, lines snap to grid)</p>
    </section>

    <section class="panel">
      <div id="stage">
        <svg id="svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges"></svg>
      </div>
      <div class="status" id="status">Load a file or draw.</div>
    </section>
  </main>

  <script>
    const svg=document.getElementById('svg'),fileInput=document.getElementById('file'),statusEl=document.getElementById('status');
    const setStatus=t=>statusEl.textContent=t,nums=s=>(s.match(/-?\d+/g)||[]).map(Number),clear=()=>{while(svg.firstChild)svg.removeChild(svg.firstChild)};

    function parseASY(text){const sh=[];for(const raw of text.split(/\r?\n/)){const line=raw.trim();if(!line||line[0]===';')continue;const head=line.split(/\s+/)[0].toUpperCase(),n=nums(line);if(head==='LINE'&&n.length>=4){const[x1,y1,x2,y2]=n.slice(-4);sh.push({t:'l',x1,y1,x2,y2});}}return sh;}
    function bounds(sh){let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;const add=(x,y)=>{minX=Math.min(minX,x);minY=Math.min(minY,y);maxX=Math.max(maxX,x);maxY=Math.max(maxY,y)};sh.forEach(s=>{add(s.x1,s.y1);add(s.x2,s.y2)});if(!isFinite(minX)){minX=0;minY=0;maxX=100;maxY=100;}const pad=16;return{x:minX-pad,y:minY-pad,w:maxX-minX+pad*2,h:maxY-minY+pad*2};}
    function drawGrid(b,step=16){const g=document.createElementNS(svg.namespaceURI,'g');g.setAttribute('stroke','#5f6d7a');g.setAttribute('stroke-width','0.6');g.setAttribute('opacity','0.25');for(let X=Math.ceil(b.x/step)*step;X<=b.x+b.w;X+=step){const l=document.createElementNS(svg.namespaceURI,'line');l.setAttribute('x1',X);l.setAttribute('y1',b.y);l.setAttribute('x2',X);l.setAttribute('y2',b.y+b.h);g.appendChild(l);}for(let Y=Math.ceil(b.y/step)*step;Y<=b.y+b.h;Y+=step){const l=document.createElementNS(svg.namespaceURI,'line');l.setAttribute('x1',b.x);l.setAttribute('y1',Y);l.setAttribute('x2',b.x+b.w);l.setAttribute('y2',Y);g.appendChild(l);}svg.appendChild(g);}
    function render(text){const sh=parseASY(text);clear();const b=bounds(sh);svg.setAttribute('viewBox',`${b.x} ${b.y} ${b.w} ${b.h}`);drawGrid(b);const g=document.createElementNS(svg.namespaceURI,'g');g.setAttribute('stroke','#0b3fa8');g.setAttribute('stroke-width','2');sh.forEach(s=>{const el=document.createElementNS(svg.namespaceURI,'line');el.setAttribute('x1',s.x1);el.setAttribute('y1',s.y1);el.setAttribute('x2',s.x2);el.setAttribute('y2',s.y2);g.appendChild(el)});svg.appendChild(g);setStatus(`Parsed ${sh.length} line(s).`);}

    fileInput.addEventListener('change',async e=>{const f=e.target.files?.[0];if(!f)return;render(await f.text())});

    svg.addEventListener('wheel',e=>{e.preventDefault();const vb=svg.viewBox.baseVal,r=svg.getBoundingClientRect(),mx=vb.x+(e.clientX-r.left)/r.width*vb.width,my=vb.y+(e.clientY-r.top)/r.height*vb.height,z=Math.pow(1.1,e.deltaY>0?1:-1),nw=vb.width*z,nh=vb.height*z,u=(mx-vb.x)/vb.width,v=(my-vb.y)/vb.height;vb.x=mx-u*nw;vb.y=my-v*nh;vb.width=nw;vb.height=nh},{passive:false});

    const snap=(val,step=16)=>Math.round(val/step)*step;

    // Click once to start, move to preview, click again to set end (snap to grid)
    let currentLine=null,start=null;
    function toSVG(e){const vb=svg.viewBox.baseVal,r=svg.getBoundingClientRect();return{x:vb.x+(e.clientX-r.left)/r.width*vb.width,y:vb.y+(e.clientY-r.top)/r.height*vb.height};}

    svg.addEventListener('click',e=>{
      const p=toSVG(e);const x=snap(p.x),y=snap(p.y);
      if(!start){ // start new line
        start={x,y};
        currentLine=document.createElementNS(svg.namespaceURI,'line');
        currentLine.setAttribute('x1',x);currentLine.setAttribute('y1',y);
        currentLine.setAttribute('x2',x);currentLine.setAttribute('y2',y);
        currentLine.setAttribute('stroke','#d22');currentLine.setAttribute('stroke-width','2');
        svg.appendChild(currentLine);
      } else { // finish line
        currentLine.setAttribute('x2',x);currentLine.setAttribute('y2',y);
        currentLine=null;start=null;
      }
    });

    svg.addEventListener('mousemove',e=>{
      if(currentLine){const p=toSVG(e);const x=snap(p.x),y=snap(p.y);currentLine.setAttribute('x2',x);currentLine.setAttribute('y2',y);}
    });

    window.addEventListener('keydown',e=>{if(e.key==='Escape'&&currentLine){currentLine.remove();currentLine=null;start=null;}});
  </script>
</body>
</html>
